# Promptfoo configuration for Kilig
# For more info: https://www.promptfoo.dev/docs/configuration/guide/

# We use a pass-through prompt because we are evaluating existing artifacts
prompts:
  - "{{content}}"

# The provider simply returns the artifact content so we can assert on it
providers:
  - id: file://scripts/pass_through_provider.js
    label: "Artifact Pass-through"

# Default options for all tests
defaultTest:
  options:
    # Use Gemini as the judge for llm-rubric assertions
    rubricProvider: google:gemini-1.5-flash-latest

tests:
  # Scientist Synthesis Validation
  - vars:
      content: file://test_artifacts/latest/scientist_analysis.txt
    assert:
      - type: javascript
        value: output.length > 100 # Basic length check
      - type: javascript
        value: |
          const required = ['Core Concept', 'Methodology', 'Results'];
          const missing = required.filter(r => !output.includes(r));
          if (missing.length > 0) return `Missing sections: ${missing.join(', ')}`;
          return true;
      - type: icontains
        value: "Methodology"

  # Narrative Comic Manifest Validation
  - vars:
      content: file://test_artifacts/latest/comic_manifest.json
    assert:
      - type: is-json
      - type: javascript
        value: |
          // Value is a JSON string of the manifest (because content was read from file)
          let manifest;
          try {
            manifest = JSON.parse(output);
          } catch (e) {
            return false; // Invalid JSON
          }
          
          // Allow empty object for dummy file case (so test fails with specific message or passes if we want to allow skipping)
          // But for robust testing, we want it to FAIL if it's the dummy file.
          if (Object.keys(manifest).length === 0) return "Manifest is empty (Dummy file used)";

          if (!manifest.pages || manifest.pages.length === 0) return "Manifest must have pages";
          
          // Check for basic layout consistency
          for (const page of manifest.pages) {
            for (const panel of page.panels) {
              if (panel.layout.x < 1 || panel.layout.y < 1) return "Panel layout coordinates must be 1-indexed (min 1)";
              if (panel.layout.w < 1 || panel.layout.h < 1) return "Panel dimensions must be positive";
            }
          }
          return true;

  # Validator Check (Optional)
  - vars:
      content: file://test_artifacts/latest/validator_report.txt
    assert:
       - type: javascript
         value: output.length > 10 # Check if validator ran
