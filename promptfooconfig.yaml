# Promptfoo Configuration for Kilig v2.0
# Evaluates agent outputs against quality assertions
# Docs: https://www.promptfoo.dev/docs/configuration/guide/

# Output paths for results
outputPath: tests/results/latest.json

# Pass-through prompt (we're evaluating existing artifacts, not generating new ones)
prompts:
  - "{{content}}"

# Pass-through provider returns artifact content for assertion evaluation
providers:
  - id: file://scripts/pass_through_provider.js
    label: "Artifact Pass-through"

# Default options for all tests
defaultTest:
  options:
    # Use Gemini as the judge for LLM-based rubric assertions
    rubricProvider: google:gemini-2.0-flash

# =============================================================================
# AGENT OUTPUT EVALUATIONS
# =============================================================================
tests:
  # ---------------------------------------------------------------------------
  # 1. SCIENTIST AGENT: Critical Analysis Output
  # ---------------------------------------------------------------------------
  - description: "Scientist Agent - Critical Analysis Structure"
    vars:
      content: file://tests/artifacts/latest/scientist_analysis.txt
    assert:
      # Must have substantial content
      - type: javascript
        value: output.length > 200
        weight: 1

      # Must contain required Kilig Analysis Format sections
      - type: javascript
        value: |
          const requiredSections = [
            'Core Concept',
            'Methodology',
            'Results'
          ];
          const optionalSections = [
            'Validity',
            'Strengths',
            'Weaknesses',
            'Visualizable Data'
          ];
          
          const foundRequired = requiredSections.filter(s => output.includes(s));
          const foundOptional = optionalSections.filter(s => output.includes(s));
          
          if (foundRequired.length < 2) {
            return `Missing core sections. Found: ${foundRequired.join(', ')}`;
          }
          return true;
        weight: 2

      # Scientific rigor check - must include data/metrics
      - type: javascript
        value: |
          const hasNumbers = /\d+(\.\d+)?%?/.test(output);
          const hasComparison = /(compared|versus|vs\.|improvement|outperform)/i.test(output);
          if (!hasNumbers && !hasComparison) {
            return "Analysis lacks quantitative data or comparisons";
          }
          return true;
        weight: 1

      # LLM-based quality rubric
      - type: llm-rubric
        value: |
          Evaluate this scientific analysis for:
          1. Clarity: Is the core concept explained clearly?
          2. Depth: Does it go beyond surface-level summary?
          3. Critical thinking: Are limitations or weaknesses identified?
          Score 1-5. Pass if score >= 3.
        weight: 2

  # ---------------------------------------------------------------------------
  # 2. NARRATIVE AGENT: Comic Manifest Output
  # ---------------------------------------------------------------------------
  - description: "Narrative Agent - Comic Manifest Structure"
    vars:
      content: file://tests/artifacts/latest/comic_manifest.json
    assert:
      # Must be valid JSON
      - type: is-json
        weight: 2

      # Must have required comic structure (5-panel rule)
      - type: javascript
        value: |
          let manifest;
          try {
            manifest = JSON.parse(output);
          } catch (e) {
            return "Invalid JSON";
          }
          
          // Allow empty object for skipped runs
          if (Object.keys(manifest).length === 0) {
            return "Manifest is empty (agent may not have run)";
          }
          
          // Check for pages array
          if (!manifest.pages || !Array.isArray(manifest.pages)) {
            return "Missing 'pages' array";
          }
          
          // Count total panels across all pages
          let totalPanels = 0;
          for (const page of manifest.pages) {
            if (page.panels && Array.isArray(page.panels)) {
              totalPanels += page.panels.length;
            }
          }
          
          // Should have at least 5 panels (5-panel rule)
          if (totalPanels < 5) {
            return `Only ${totalPanels} panels found. Expected at least 5.`;
          }
          
          return true;
        weight: 2

      # Panel layout validity check
      - type: javascript
        value: |
          let manifest;
          try {
            manifest = JSON.parse(output);
          } catch (e) {
            return true; // Skip if not valid JSON (caught by previous assertion)
          }
          
          if (!manifest.pages) return true;
          
          for (const page of manifest.pages) {
            if (!page.panels) continue;
            
            for (const panel of page.panels) {
              // Check layout object exists
              if (!panel.layout) {
                return "Panel missing 'layout' object";
              }
              
              // Check required layout properties
              const { x, y, w, h } = panel.layout;
              if (typeof x !== 'number' || typeof y !== 'number') {
                return "Panel layout missing x/y coordinates";
              }
              if (typeof w !== 'number' || typeof h !== 'number') {
                return "Panel layout missing width/height";
              }
              
              // Layout coordinates should be positive
              if (x < 0 || y < 0 || w <= 0 || h <= 0) {
                return "Panel layout has invalid dimensions";
              }
              
              // Check for visualization type
              if (!panel.type && !panel.visual_type && !panel.component) {
                return "Panel missing visual type identifier";
              }
            }
          }
          
          return true;
        weight: 1

      # Check for Revideo template usage (required by spec)
      - type: javascript
        value: |
          let manifest;
          try {
            manifest = JSON.parse(output);
          } catch (e) {
            return true;
          }
          
          if (!manifest.pages) return true;
          
          const revideoTypes = ['process_flow', 'bar_chart', 'line_chart', 'flowchart', 'comparison'];
          let revideoCount = 0;
          
          for (const page of manifest.pages) {
            if (!page.panels) continue;
            for (const panel of page.panels) {
              const type = (panel.type || panel.visual_type || '').toLowerCase();
              if (revideoTypes.some(rt => type.includes(rt))) {
                revideoCount++;
              }
            }
          }
          
          if (revideoCount < 2) {
            return `Only ${revideoCount} Revideo-compatible visuals found. Expected at least 2.`;
          }
          
          return true;
        weight: 1

  # ---------------------------------------------------------------------------
  # 3. VALIDATOR AGENT: QC Report Output
  # ---------------------------------------------------------------------------
  - description: "Validator Agent - QC Report"
    vars:
      content: file://tests/artifacts/latest/validator_report.txt
    assert:
      # Validator should produce some output
      - type: javascript
        value: output.length > 20
        weight: 1

      # Should indicate pass/fail status
      - type: javascript
        value: |
          const hasStatus = /(pass|fail|valid|invalid|approved|rejected|error|success)/i.test(output);
          if (!hasStatus) {
            return "QC report missing pass/fail status indicator";
          }
          return true;
        weight: 1

  # ---------------------------------------------------------------------------
  # 4. AGENTIC RAG: Hybrid Search Quality (Optional)
  # ---------------------------------------------------------------------------
  - description: "Agentic RAG - Search Results Quality"
    vars:
      content: file://tests/artifacts/latest/search_results.json
    assert:
      # If search results exist, validate structure
      - type: javascript
        value: |
          // This test is optional - skip if file is empty/missing
          if (!output || output.trim() === '' || output === '{}') {
            return true; // Skip
          }
          
          let results;
          try {
            results = JSON.parse(output);
          } catch (e) {
            return "Search results not valid JSON";
          }
          
          // Check for hits array
          if (!results.hits || !Array.isArray(results.hits)) {
            return "Missing 'hits' array in search results";
          }
          
          // Each hit should have content and score
          for (const hit of results.hits) {
            if (!hit.chunkText && !hit.content) {
              return "Search hit missing content";
            }
            if (typeof hit.score !== 'number') {
              return "Search hit missing score";
            }
          }
          
          return true;
        weight: 1
