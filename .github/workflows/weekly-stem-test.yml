name: Weekly STEM Pipeline Test

on:
  schedule:
    # Every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      paper_url:
        description: 'ArXiv paper URL to test'
        required: false
        default: 'https://arxiv.org/abs/1706.03762'

env:
  NODE_VERSION: '20'
  CACHE_ENABLED: 'true'
  CACHE_PROVIDER: 'file'
  TESTING_MODE: 'resilient'

jobs:
  test-stem-papers:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        paper:
          # Computer Science / AI
          - url: 'https://arxiv.org/abs/1706.03762'
            name: 'Attention Is All You Need (Transformers)'
            domain: 'AI'
          # Computer Vision
          - url: 'https://arxiv.org/abs/2010.11929'
            name: 'Vision Transformer (ViT)'
            domain: 'CV'
          # Reinforcement Learning
          - url: 'https://arxiv.org/abs/1602.01783'
            name: 'Asynchronous Methods for Deep RL (A3C)'
            domain: 'RL'
          # NLP
          - url: 'https://arxiv.org/abs/1810.04805'
            name: 'BERT: Pre-training Deep Bidirectional Transformers'
            domain: 'NLP'
          # Generative AI
          - url: 'https://arxiv.org/abs/2006.11239'
            name: 'Denoising Diffusion Probabilistic Models'
            domain: 'GenAI'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create test directories
        run: mkdir -p tests/artifacts tests/results

      - name: Run pipeline test
        run: npm run test:pipeline
        env:
          PAPER_URL: ${{ matrix.paper.url }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        continue-on-error: true

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.paper.domain }}
          path: |
            tests/artifacts/
            tests/results/
          retention-days: 30

  # Summary job that runs after all tests
  summarize:
    runs-on: ubuntu-latest
    needs: test-stem-papers
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate summary
        run: |
          echo "## Weekly STEM Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          for dir in all-results/test-results-*/; do
            domain=$(basename "$dir" | sed 's/test-results-//')
            if [ -f "$dir/tests/results/latest.json" ]; then
              echo "| $domain | ✅ Complete |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $domain | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure (optional)
        if: failure()
        run: |
          echo "Tests failed! Configure Slack/Discord webhook for notifications."
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Weekly STEM tests failed!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
